var last_kanji;const kanji_history={};function start(){renderShadow(),window.addEventListener("keydown",e=>{eventRouter(e)}),log()}function eventRouter(e){e.ctrlKey&&("KeyY"==e.code&&(e.preventDefault(),e.stopPropagation(),kanjiLookup()),"KeyM"==e.code&&(e.preventDefault(),e.stopPropagation(),defLookup()))}function renderShadow(){let e=document.createElement("div");e.id="jisho-extension-shadow",document.body.append(e);let t=e.attachShadow({mode:"open"}),n=document.createElement("div");n.id="jisho-extension-container",n.innerHTML=jisho_extension_template,t.appendChild(n),t.querySelectorAll(".close-gui").forEach(e=>{e.addEventListener("click",()=>{guiState([])})})}async function kanjiLookup(e=null){if(!e&&!window.getSelection)return;let t;if(!e&&kanji_history[t=userSelection(1)]){if(t===last_kanji)return last_kanji="",guiState([]);last_kanji=t,e=kanji_history[t],guiState(["container","kanji-lookup"])}let n=e||await scrapeKanji(t);if("error"===n||(e||(n.svg=await scrapeStrokes(n.svg_url)),"error"===n.svg))return error();let r=renderStrokes(n.svg),i=document.getElementById("jisho-extension-shadow").shadowRoot;i.querySelector(".kanji>h1").innerHTML=n.kanji,i.querySelector(".kanji>a").href=n.kanji_url,i.querySelector(".kanji>p").innerHTML=n.jlpt;let a=i.querySelector(".readings-meanings>.translation"),o=i.querySelector(".readings-meanings>.kun"),l=i.querySelector(".readings-meanings>.on");a.innerHTML="",o.innerHTML='<li class="title">Kun</li>',l.innerHTML='<li class="title">On</li>',n.translations.forEach(e=>{appendLi(e,a)}),n.kuns.forEach(e=>{appendLi(e,o)}),n.ons.forEach(e=>{appendLi(e,l)});let s=i.querySelector(".stroke-order");s.innerHTML="",s.append(r);let c=i.querySelector(".history"),u=document.createElement("li");c.innerHTML.includes(n.kanji)||(u.innerHTML=n.kanji,c.prepend(u),kanji_history[n.kanji]=n,u.addEventListener("click",function(){kanjiLookup(kanji_history[this.innerHTML])})),c.children.length>10&&(delete kanji_history[c.children[10].innerHTML],c.children[10].remove()),guiState(["container","kanji-lookup"])}async function scrapeKanji(e){guiState(["container","loader"]);let t={};t.kanji=e,t.kanji_url=`https://jisho.org/search/${encodeURI(t.kanji)}%20%23kanji`;let n=await scrape(t.kanji_url);if("error"===n)return"error";try{t.svg_url="https:"+n.split("var url = '")[1].split("';")[0]}catch(r){return"error"}if("error"===(n=washPage(n)))return"error";let i=document.createElement("div");i.innerHTML=n,t.translations=i.querySelector(".kanji-details__main-meanings");let a=i.querySelectorAll(".kanji-details__main-readings-list");try{t.jlpt=i.querySelector(".kanji_stats>.jlpt>strong").innerHTML}catch(o){t.jlpt="N/A"}try{t.translations=t.translations.textContent.trim().split(",")}catch(l){t.translations=[]}try{t.kuns=a[0].textContent.trim().split("、 ")}catch(s){t.kuns=[]}try{t.ons=a[1].textContent.trim().split("、 ")}catch(c){t.ons=[]}return last_kanji=t.kanji,i.remove(),t}function renderStrokes(e){let t=document.createElement("div"),n=e.querySelectorAll("path");for(let r=0;r<n.length;r++){let i=e.cloneNode(!0),a=i.querySelectorAll("path");for(let o=0;o<a.length;o++){let l=a[o];if(l.classList.add("active"),l==a[r]){l.classList.add("current");break}}let s=a[r].getAttribute("d").replaceAll("C","c"),c=[s.split("M")[1].split(",")[0],s.split("M")[1].split(",")[1].split("c")[0]];i.innerHTML+=`<circle cx="${c[0]}" cy="${c[1]}" r="5" />`,t.append(i)}return t}async function scrapeStrokes(e){let t=await scrape(e),n=document.createElement("div");n.innerHTML=t;let r=n.querySelector("svg");return r.setAttribute("width","100%"),r.setAttribute("height","100%"),r.children[1].remove(),r}async function defLookup(){if(!history&&!window.getSelection)return;let e=userSelection(),t=await scrapeDefs(e,10);if("error"===t)return error();console.log(t),loadDefinition(t,0),guiState(["container","definition-lookup"])}function loadDefinition(e,t){let n=e[t],r=document.getElementById("jisho-extension-shadow").shadowRoot;r.querySelector(".definition-lookup").innerHTML=definition_template,r.querySelector(".d-l .close-gui").addEventListener("click",()=>{guiState([])}),r.querySelector("a").href=n.link,n.word.forEach(e=>{let t=r.querySelector(".word>ul");""==e.furigana&&(e.furigana="&nbsp"),appendLi(`<span>${e.furigana}</span>${e.kanji}`,t)});for(let i=0;i<n.meanings.length;i++){let a=n.meanings[i],o=r.querySelector(".meanings"),l=document.createElement("p");l.className="tag",l.innerHTML=a.tag;let s=document.createElement("ul");s.className="meaning";appendLi(`${i+1}`,s).className="index",a.meaning.forEach(e=>{appendLi(e.trim(),s)}),o.append(l,s)}def_btns=r.querySelector(".definitions");for(let c=0;c<e.length;c++){let u;u=e[c].exact_match?appendLi(`exact match ${c+1}`,def_btns):appendLi(`definition ${c+1}`,def_btns),e[c]==n&&(u.className="active"),u.addEventListener("click",()=>{loadDefinition(e,c)}),def_btns.append(u)}}async function scrapeDefs(e){guiState(["container","loader"]);let t=await scrape(`https://jisho.org/search/${encodeURI(e)}`);if("error"===t||"error"===(t=washPage(t)))return"error";let n=document.createElement("div");n.innerHTML=t;let r=n.querySelectorAll("#primary .concept_light.clearfix"),i=[];for(let a=0;a<r.length;a++){let o={};o.word=[],o.meanings=[],o.link=r[a].querySelector(".light-details_link").href,o.exact_match=r[a].parentElement.classList.contains("exact_block");let l=r[a].querySelector(".text").textContent.trim(),s=r[a].querySelectorAll(".furigana>span");for(let c=0;c<l.length;c++){let u=s[c]?s[c].textContent:"";o.word.push({kanji:l[c],furigana:u})}let d=r[a].querySelector(".meanings-wrapper"),p=d.querySelectorAll(".meaning-tags"),g=d.querySelectorAll(".meaning-meaning");for(let h=0;h<g.length;h++)o.meanings.push({tag:p[h].textContent,meaning:g[h].textContent.split(";")});if(i.push(o),2==a)break}return n.remove(),i}function scrape(e){return new Promise((t,n)=>{chrome.runtime.sendMessage({scrape:!0,url:e},e=>{e?t(e):n("error")})})}function washPage(e){try{return e=(e=e.replaceAll("<use xlink:href=","<p data-use=").replaceAll("></use>","></p>")).replaceAll("src=","data-src=")}catch(t){return"error"}}function userSelection(e){let t=window.getSelection();return t=t.baseNode.textContent.substring(t.baseOffset,t.extentOffset),e&&(t=t.substring(0,e)),t}function appendLi(e,t){let n=document.createElement("li");return n.innerHTML=e,t.append(n),n}start();const gui_sections=["container","error","loader","kanji-lookup","definition-lookup"];function error(){guiState(["container","error"]),setTimeout(()=>{guiState([])},1200)}function guiState(e){let t=document.getElementById("jisho-extension-shadow").shadowRoot;gui_sections.forEach(n=>{e.includes(n)?t.querySelector("."+n).classList.add("active"):t.querySelector("."+n).classList.remove("active")})}function log(){let e=`

     ██████╗ ██╗  ████╗  ██╗      ████╗
      ╚═██╔╝ ╚═╝ ██ ╔═╝  ██╚╗    ██  ██╗
        ██║  ██╗  ████╗  █████╗  ██  ██║
    ██  ██║  ██║   ╚╗██╗ ██╔═██╗ ██  ██║
    ╚████╔╝  ██║ █████╔╝ ██║ ██║  ████╔╝
     ╚═══╝   ╚═╝ ╚════╝  ╚═╝ ╚═╝  ╚═══╝
                ON THE FLY ╗
                ╚══════════╝

          jisho scraping extension

    `;console.log(`%c ${e}`,"color: #60b024")}